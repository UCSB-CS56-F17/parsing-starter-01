<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FiniteStateAutomaton.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">cs56Parser</a> &gt; <a href="index.source.html" class="el_package">edu.ucsb.cs56.pconrad.parsing.tokenizer</a> &gt; <span class="el_source">FiniteStateAutomaton.java</span></div><h1>FiniteStateAutomaton.java</h1><pre class="source lang-java linenums">package edu.ucsb.cs56.pconrad.parsing.tokenizer;

import java.util.TreeMap;
import java.util.TreeSet;
import java.util.Map;
import java.util.ArrayList;

/** 
	Implements a finite state automaton (also known as a finite state machine)

	@author Phill Conrad
*/

<span class="fc" id="L14">public class FiniteStateAutomaton {</span>

<span class="fc" id="L16">    private String input = null;</span>
<span class="fc" id="L17">    private int pos = 0;</span>
<span class="fc" id="L18">    private State currState = null;</span>
<span class="fc" id="L19">    private State nextState = null;</span>
<span class="fc" id="L20">    private State startState = null;</span>
<span class="fc" id="L21">    private String accumulatedToken = &quot;&quot;;</span>

<span class="fc" id="L23">    private TreeSet&lt;Character&gt; legalChars = new TreeSet&lt;Character&gt;();</span>

	/**
	   Provide the input to the machine
	*/
    public void setInput(String input) {
<span class="fc" id="L29">		this.input = input;</span>
<span class="fc" id="L30">		this.pos = 0;</span>
<span class="fc" id="L31">		resetToStart();</span>
<span class="fc" id="L32">    }</span>

	/**
	   Get the remaining input that has not yet been consumed
	*/
    public String getRemainingInput() {
<span class="fc bfc" id="L38" title="All 2 branches covered.">		if (this.pos &gt;= input.length()) {</span>
<span class="fc" id="L39">			return &quot;&quot;;</span>
		}		
<span class="fc" id="L41">		return input.substring(pos);	</span>
    }
    
    private class State {
		private int num;
<span class="fc" id="L46">		private TokenMaker tm=null;</span>
<span class="fc" id="L47">		private TreeMap&lt;Character,State&gt; nextState =</span>
			new TreeMap&lt;Character,State&gt;();
		
<span class="fc" id="L50">		public State(int num) {</span>
<span class="fc" id="L51">			this.num = num;</span>
<span class="fc" id="L52">		}</span>
		
		@Override
		public String toString() {
<span class="fc" id="L56">			String retVal = &quot;&quot;;</span>
<span class="fc bfc" id="L57" title="All 2 branches covered.">			for(Map.Entry&lt;Character,State&gt; entry : nextState.entrySet()) {</span>
<span class="fc bfc" id="L58" title="All 2 branches covered.">				if (!retVal.equals(&quot;&quot;))</span>
<span class="fc" id="L59">					retVal += &quot;, &quot;; </span>
<span class="fc" id="L60">				char c = entry.getKey();</span>
<span class="fc" id="L61">				State s = entry.getValue();</span>
<span class="fc" id="L62">				retVal += &quot;'&quot; + c + &quot;'-&gt;&quot; + s.num;</span>
<span class="fc" id="L63">			}</span>

<span class="fc bfc" id="L65" title="All 2 branches covered.">			return &quot;&quot; + this.num + (this.tm==null?&quot;: &quot;:&quot;*: &quot;) + retVal;</span>
		}
		
		
    } // inner class State
	
<span class="fc" id="L71">    private TreeMap&lt;Integer,State&gt; states =</span>
		new TreeMap&lt;Integer,State&gt;();
    
    private State getState(int num) {
<span class="fc" id="L75">		State s = states.get(num);</span>
<span class="fc bfc" id="L76" title="All 2 branches covered.">		if (s==null) {</span>
<span class="fc" id="L77">			s = new State(num);</span>
<span class="fc" id="L78">			states.put(num,s);</span>
		}
<span class="fc" id="L80">		return s;</span>
    }
	    
    public void addState(int num) {
<span class="fc" id="L84">		State s = getState(num);</span>
<span class="fc" id="L85">    }</span>
		
    public void addState(int num, TokenMaker tm) {
<span class="fc" id="L88">		State s = getState(num);</span>
<span class="fc" id="L89">		s.tm = tm;</span>
<span class="fc" id="L90">    }</span>

    public void addTransition(char c, int from, int to) {
<span class="fc" id="L93">		State fromS = getState(from);</span>
<span class="fc" id="L94">		State toS = getState(to);</span>
<span class="fc" id="L95">		fromS.nextState.put(c,toS);</span>
<span class="fc" id="L96">		legalChars.add(c);</span>
<span class="fc" id="L97">    }</span>
	
    @Override
    public String toString() {
<span class="fc" id="L101">		String retVal = &quot;&quot;;</span>
<span class="fc" id="L102">		retVal += &quot;FSA: \n&quot;;	</span>
<span class="fc bfc" id="L103" title="All 2 branches covered.">		for(Map.Entry&lt;Integer,State&gt; entry : states.entrySet()) {</span>
<span class="fc" id="L104">			int num = entry.getKey();</span>
<span class="fc" id="L105">			State s = entry.getValue();</span>
<span class="fc" id="L106">			retVal += &quot;\t&quot;+ s.toString() + &quot;\n&quot;; </span>
<span class="fc" id="L107">		}</span>
<span class="fc" id="L108">		return retVal;</span>
    }
	

    public void resetToStart() {
<span class="fc" id="L113">		this.startState = states.get(0);</span>
<span class="fc" id="L114">		this.currState = startState;</span>
<span class="fc" id="L115">		this.accumulatedToken = &quot;&quot;;</span>
<span class="fc bfc" id="L116" title="All 2 branches covered.">		if (this.currState==null) {</span>
<span class="fc" id="L117">			throw new IllegalStateException(&quot;FSA instance does not have a start state (state 0) defined.&quot;);</span>
		}
<span class="fc" id="L119">    }</span>
	
    private char currChar() {
<span class="fc" id="L122">		return this.input.charAt(pos);</span>
    }
	
	private Token consumeCurrCharAndEmitErrorToken() {
		// No transition for current character.
		// Emit error token, consuming current character
<span class="fc" id="L128">		String s = &quot;&quot; + currChar();</span>
<span class="fc" id="L129">		Token t = new ErrorToken(s);</span>
<span class="fc" id="L130">		this.pos++;</span>
<span class="fc" id="L131">		resetToStart();	    </span>
<span class="fc" id="L132">		return t;</span>
	}

	private void processStates() {
		
		// Keep moving through states, building up the string representing the token
		// Until there is no transition you can make
		
<span class="fc bfc" id="L140" title="All 2 branches covered.">		while (this.nextState != null) {	    </span>
<span class="fc" id="L141">			this.accumulatedToken += currChar();</span>
<span class="fc" id="L142">			this.currState = this.nextState; // advance the state</span>
<span class="fc" id="L143">			this.pos++;                      // consume the character</span>
			
<span class="fc bfc" id="L145" title="All 2 branches covered.">			if ( this.pos &gt;= this.input.length() ) {</span>
				// If we've reached the end, don't look at the character
				// There is no transition we can make
<span class="fc" id="L148">				this.nextState = null; </span>
			} else {
<span class="fc" id="L150">				this.nextState = this.currState.nextState.get(currChar());</span>
			}
		}
<span class="fc" id="L153">	}</span>

	private Token tokenForCurrentState() {
<span class="fc" id="L156">		Token t = currState.tm.makeToken(accumulatedToken.trim());</span>
<span class="fc" id="L157">		resetToStart();</span>
<span class="fc" id="L158">		return t;</span>
	}

	private Token errorTokenForAccumulatedInput() {
<span class="fc" id="L162">		Token t = new ErrorToken(accumulatedToken.trim());</span>
<span class="fc" id="L163">		resetToStart();</span>
<span class="fc" id="L164">		return t;</span>
	}

	private Token errorTokenForIllegalChar() {
<span class="fc" id="L168">		Token t = new ErrorToken(&quot;&quot; + currChar());</span>
<span class="fc" id="L169">		pos ++;</span>
<span class="fc" id="L170">		resetToStart();</span>
<span class="fc" id="L171">		return t;</span>
	}

    public Token nextToken() {
		
<span class="fc bfc" id="L176" title="All 2 branches covered.">		if (this.input == null) </span>
<span class="fc" id="L177">			throw new IllegalStateException(&quot;must call setInput before calling nextToken&quot;);	   		</span>

<span class="fc bfc" id="L179" title="All 2 branches covered.">		if (this.getRemainingInput().equals(&quot;&quot;)) </span>
<span class="fc" id="L180">			return null;			   </span>

<span class="fc" id="L182">		this.nextState = this.currState.nextState.get(currChar());</span>
		
<span class="fc bfc" id="L184" title="All 2 branches covered.">		if (this.nextState == null) </span>
<span class="fc" id="L185">			return this.consumeCurrCharAndEmitErrorToken();</span>
				
		// Otherwise, we have a transition for this character.
		// As long as we continue to have a next state,
		// add this character to the token, and go to that state
		
<span class="fc" id="L191">		this.processStates();		</span>

		// if this is an accepting state, emit the token		
<span class="fc bfc" id="L194" title="All 2 branches covered.">		if (currState.tm != null) </span>
<span class="fc" id="L195">			return tokenForCurrentState();</span>
		
		// if we have accumulated something non blank, emit an error token		
<span class="fc bfc" id="L198" title="All 2 branches covered.">		if (!accumulatedToken.trim().equals(&quot;&quot;))</span>
<span class="fc" id="L199">			return errorTokenForAccumulatedInput();</span>
		
		// if we've encountered an illegal character (thus it wasn't added
		// to the accumulated token)
		
<span class="fc bfc" id="L204" title="All 2 branches covered.">		if (  this.pos &lt; input.length() ) {</span>
			// assert( !legalChars.contains(currChar()));
<span class="fc" id="L206">			return errorTokenForIllegalChar();</span>
		}
		
<span class="fc" id="L209">		resetToStart();	</span>
<span class="fc" id="L210">		return null;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>